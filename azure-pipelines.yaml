name: $(date:yyyyMMdd)$(rev:.r)

variables:
  buildConfiguration: "Release"

trigger:
  branches:
    include:
      - "*"
  paths:
    include:
      - src/*
      - azure-pipelines.yaml

schedules:
- cron: "0 0 * * *" 
  displayName: Daily at midnight 
  branches:
    include:
    - main
  always: true

stages:
  - stage: ci
    displayName: "CI"
    jobs:
      - job: build
        displayName: "Build"
        pool:
          vmImage: windows-2022
        steps:
          - task: DotNetCoreCLI@2
            displayName: 'dotnet publish'
            inputs:
              command: publish
              publishWebProjects: false
              projects: '**/*.csproj'
              arguments: '-c $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/app'
              zipAfterPublish: false
              modifyOutputPath: false

          - task: DotNetCoreCLI@2
            displayName: 'dotnet  run'
            inputs:
              command: custom
              custom: ES.ThreatFeed.dll
              workingDirectory: '$(Build.ArtifactStagingDirectory)/app'
         
          - publish: "$(Build.ArtifactStagingDirectory)/app/Output"
            artifact: "feed"
            displayName: "artifacts - publish - feed"


  - ${{ if eq(variables['Build.SourceBranchName'], 'main') }}:
    - stage: cd
      displayName: "CD"
      dependsOn: "ci"
      condition: and(succeeded(), in(variables['Build.Reason'], 'IndividualCI', 'Manual'), in(variables['Build.SourceBranchName'], 'main'))
      jobs:
        - job: release
          displayName: "Release"
          pool:
            vmImage: ubuntu-latest
          variables:
            - group: "OpenSource.GitHub"
          steps:
            - checkout: none

            - download: current
              artifact: "feed"
              displayName: "artifacts - download - feed"

            - script: |
                git config --global user.email "$(emberstack-agent-email)"
                git config --global user.name "$(emberstack-agent-name)"
                git config --global http.postBuffer 1048576000
                git clone https://$(emberstack-agent-username):$(emberstack-agent-pat)@github.com/emberstack/threat-feed.git

                cd threat-feed
                rm -f Feed
                mkdir -p Feed
                cp -a $(Pipeline.Workspace)/feed/.  Feed

                git add .
                git status
                git commit -m "Feed Release"
                git push
              displayName: "github - commit - feed"
